# 📊 Notion Integration - Complete Guide

Your VoiceFast agent now automatically saves every report to your Notion database!

## ✅ Status: ACTIVE

Notion integration is fully implemented and tested.

## 🎯 What It Does

**Automatic Database Storage**: Every time the agent processes a voice or text message, it:

1. ✅ Extracts all agent data
2. ✅ Creates a new page in your Notion database
3. ✅ Populates all properties (contact info, problems, constraints, etc.)
4. ✅ Adds formatted content blocks with problems, research items, and full report
5. ✅ Returns the Notion URL to you via Telegram
6. ✅ Saves local backup files (as before)

## 🏗️ Architecture

```
Voice/Text Message
        ↓
   Transcription
        ↓
   Agent Analysis
        ↓
    ┌─────┴─────┐
    ↓           ↓
Save Local   Save Notion
    ↓           ↓
    └─────┬─────┘
          ↓
    Send to Telegram
    (with Notion link)
```

## 📊 Database Properties

Your Notion database will be populated with these properties for each report:

| Property | Type | Example | Description |
|----------|------|---------|-------------|
| **Name** | Title | "Sarah Johnson" | Contact name (page title) |
| **Company** | Rich Text | "TechStart Inc" | Company name |
| **Contact Handle** | Rich Text | "+1-555-0123" | WhatsApp/Telegram/Discord handle |
| **Platform** | Select | "WhatsApp" | Contact platform |
| **Problems Count** | Number | 3 | Total problems identified |
| **Budget** | Rich Text | "$15,000" | Budget constraint |
| **Deadline** | Rich Text | "2 months" | Timeline constraint |
| **Team Size** | Rich Text | "5 developers" | Team size |
| **Tech Stack** | Rich Text | "Node.js, React" | Technology stack |
| **Research Count** | Number | 5 | Solutions found |
| **Top Solution** | Rich Text | "API Optimization" | First research item |
| **Source** | Select | "Voice" or "Text" | Input method |
| **Status** | Select | "New" | Processing status |
| **Local File** | Rich Text | "output/agent-..." | Local backup path |

## 📄 Page Content Structure

Each Notion page contains beautifully formatted blocks:

### 1. Problems Section
```
🚨 Problems Identified
• Customer support overwhelmed with 200 daily tickets
• Manual inventory management causing errors
• Lack of analytics for customer behavior
```

### 2. Constraints Section
```
📋 Constraints
💰 Budget: $15,000
⏰ Deadline: 2 months
👥 Team Size: 5 developers
🔧 Tech Stack: Node.js, React
```

### 3. Priorities Section (if available)
```
🎯 Priorities
• Fix API performance (Impact: 9/10, Effort: 4/10)
• Implement security patches (Impact: 8/10, Effort: 2/10)
```

### 4. Research Items
```
🔍 Research Items

### Intercom AI Chatbot
🔗 URL: https://intercom.com/ai-chatbot
💡 Why Relevant: Automates repetitive support queries
📊 Impact: 9/10 | Effort: 3/10

### Stripe Checkout
🔗 URL: https://stripe.com/checkout
💡 Why Relevant: Simplifies checkout process
📊 Impact: 8/10 | Effort: 2/10
```

### 5. Full Report (if generated)
```
📝 Full Report
[Complete markdown analysis]
```

### 6. Metadata Footer
```
Generated by VoiceFast Agent
Source: voice
Timestamp: 2025-01-15T10:30:45.123Z
```

## 🚀 How to Use

### For Telegram Bot

Just run the bot normally:

```bash
npm run bot
```

Send a voice or text message, and the agent will:
1. Process your message
2. Save to Notion automatically
3. Send you the Notion URL in Telegram

**Example Telegram output:**
```
🤖 VoiceFast Agent Report
[... full report ...]

🔗 View in Notion:
https://www.notion.so/16f381646b5d81a2b6cbe2ca00d88b10
```

### For CLI Mode

Run with text input:

```bash
npm run run
```

The agent will:
1. Process the example text
2. Save to Notion
3. Print the Notion URL to console

**Example console output:**
```
📝 Saving to Notion...
✅ Saved to Notion (attempt 1/3): https://www.notion.so/...
✅ Notion page created: https://www.notion.so/...
```

## 🧪 Testing

### Test Notion Connection

```bash
npm run test-notion
```

**Expected output:**
```
🧪 Testing Notion Integration...

📋 Checking environment variables...
✅ NOTION_API_KEY found
✅ NOTION_DATABASE_ID found

🔌 Testing connection to Notion...

✅ Notion connection successful!
   Database ID: 16f381646b5d81a2b6cbe2ca00d88b10

✅ Notion integration is working correctly!
```

### Test with Voice Message

1. Start the bot: `npm run bot`
2. Send a voice message with test data
3. Check your Notion database for the new page
4. Verify all properties are populated
5. Check the Telegram bot sends you the Notion URL

## 🔧 Configuration

### Environment Variables

Already configured in your `.env`:

```env
NOTION_API_KEY=
NOTION_DATABASE_ID=your_database_id_here
```

### Notion Database Setup

To ensure all properties work correctly, create these properties in your Notion database:

**Required Properties:**
- Name (Title) - Auto-created
- Status (Select) - Options: "New", "Contacted", "In Progress", "Closed"
- Source (Select) - Options: "Voice", "Text"

**Optional Properties** (recommended):
- Company (Rich Text)
- Contact Handle (Rich Text)
- Platform (Select) - Options: "WhatsApp", "Telegram", "Discord"
- Problems Count (Number)
- Budget (Rich Text)
- Deadline (Rich Text)
- Team Size (Rich Text)
- Tech Stack (Rich Text)
- Research Count (Number)
- Top Solution (Rich Text)
- Local File (Rich Text)

**Note:** The integration will still work if these properties don't exist - they'll just be skipped.

## 🔄 Retry Logic

The integration includes automatic retry on failure:

- **Max retries**: 3 attempts
- **Backoff**: Exponential (1s, 2s, 3s)
- **Fallback**: If all attempts fail, local files are still saved

**Console output during retries:**
```
📝 Saving to Notion...
⚠️  Notion save attempt 1/3 failed: Request timeout
   Retrying in 1000ms...
✅ Saved to Notion (attempt 2/3): https://www.notion.so/...
```

## 🛡️ Error Handling

### If Notion Fails

The bot continues working and:
- ✅ Saves to local files (as backup)
- ✅ Sends report to Telegram
- ⚠️  Logs Notion error to console
- ℹ️  Doesn't send Notion URL to user

**Console output:**
```
📝 Saving to Notion...
⚠️  Notion save attempt 1/3 failed: ...
⚠️  Notion save attempt 2/3 failed: ...
⚠️  Notion save attempt 3/3 failed: ...
❌ All Notion save attempts failed
⚠️  Notion: Save failed (continuing anyway)

📱 Sending results to Telegram...
✅ Complete! Results sent to user.
```

**User experience:** Gets full report, just without Notion link.

### Common Errors & Solutions

| Error | Cause | Solution |
|-------|-------|----------|
| "NOTION_API_KEY not found" | Missing env var | Add to `.env` file |
| "NOTION_DATABASE_ID not found" | Missing env var | Add to `.env` file |
| "object_not_found" | Wrong database ID | Check database ID is correct |
| "unauthorized" | Invalid API key | Regenerate integration token |
| "validation_error" | Property type mismatch | Check database properties |

## 📈 Benefits

### Immediate Benefits
1. **Searchable** - Find any contact by name, company, or problem
2. **Organized** - All leads in one centralized database
3. **Collaborative** - Share with team members easily
4. **Visual** - See status, priorities, and metrics at a glance
5. **Persistent** - Never lose data even if local files are deleted

### Workflow Benefits
1. **Filter** - By budget, deadline, platform, status
2. **Sort** - By problems count, research count, date
3. **Views** - Create custom views for different team members
4. **Relations** - Link to other Notion databases (CRM, tasks, etc.)
5. **Automations** - Set up Notion automations based on properties

### Analysis Benefits
1. **Trends** - Most common problems across all contacts
2. **Success Metrics** - Track conversion rates by source
3. **Resource Planning** - See budget and timeline distribution
4. **Tech Stack Analysis** - Most requested technologies
5. **Research Effectiveness** - Which solutions get recommended most

## 🎨 Customization

### Change Page Title Format

Edit `notion-integration.ts` line 64:

```typescript
const pageTitle =
  full_report.contact_name ||
  full_report.company ||
  "New Contact";

// Change to:
const pageTitle = `${full_report.company} - ${full_report.contact_name}` ||
  full_report.contact_name ||
  "New Contact";
```

### Add Custom Properties

```typescript
// In the properties object (line 75+)
properties["Custom Field"] = {
  rich_text: [{ text: { content: "custom value" } }],
};
```

### Change Status Options

Update your Notion database "Status" select property options.

### Modify Content Blocks

Edit the `children` array in `notion-integration.ts` (lines 135-300) to change formatting.

## 📊 Integration Points

### Files Modified

| File | Changes | Purpose |
|------|---------|---------|
| `notion-integration.ts` | NEW | Notion API logic |
| `telegram-bot.ts` | Updated | Call saveToNotion after processing |
| `run-agent.ts` | Updated | Call saveToNotion in CLI mode |
| `test-notion.ts` | NEW | Test Notion connection |
| `package.json` | Updated | Add test-notion script |
| `.env` | Updated | Add Notion credentials |

### Function Flow

```typescript
processVoiceMessage()
  → runWorkflowWithUpdates()
  → saveToNotionWithRetry()
    → saveToNotion()
      → notion.pages.create()
  → sendTelegramMessage() [with Notion URL]
```

## 🔐 Security

- ✅ API key stored in `.env` (not committed to git)
- ✅ `.env` in `.gitignore`
- ✅ HTTPS for all Notion API calls
- ✅ Data encrypted at rest by Notion
- ✅ Integration has minimal permissions (create pages only)
- ✅ No sensitive data exposed in URLs

## 📚 API Reference

### `saveToNotion(result, source, localFilePath)`

Saves agent results to Notion database.

**Parameters:**
- `result` (AgentResult): Complete agent output
- `source` ("voice" | "text"): Input method
- `localFilePath` (string, optional): Path to local JSON file

**Returns:** Promise<string> - Notion page URL

**Throws:** Error if save fails

**Example:**
```typescript
const url = await saveToNotion(result, "voice", "/path/to/output.json");
console.log(`Saved to: ${url}`);
```

### `saveToNotionWithRetry(result, source, localFilePath, maxRetries)`

Same as `saveToNotion` but with automatic retry logic.

**Parameters:**
- `result` (AgentResult): Complete agent output
- `source` ("voice" | "text"): Input method
- `localFilePath` (string, optional): Path to local JSON file
- `maxRetries` (number, optional): Max retry attempts (default: 3)

**Returns:** Promise<string | null> - Notion page URL or null if all retries fail

**Example:**
```typescript
const url = await saveToNotionWithRetry(result, "voice", "/path/to/output.json", 3);
if (url) {
  console.log(`Success: ${url}`);
} else {
  console.error("Failed after retries");
}
```

### `testNotionConnection()`

Tests connection to Notion API and database.

**Returns:** Promise<boolean> - true if connection successful

**Example:**
```typescript
const isConnected = await testNotionConnection();
if (isConnected) {
  console.log("Ready to save!");
}
```

## 🎯 Next Steps

Now that Notion integration is working:

1. **Customize Properties** - Add fields specific to your workflow
2. **Create Views** - Set up filtered views for different team members
3. **Add Automations** - Notion automations for status changes, notifications
4. **Connect CRM** - Link to your existing CRM or sales tools
5. **Analytics Dashboard** - Create charts and metrics in Notion

## 🆘 Troubleshooting

### "unauthorized" Error
- Regenerate your Notion integration token
- Make sure the integration has access to your database

### Properties Not Appearing
- Create the properties in your Notion database first
- Check property names match exactly (case-sensitive)

### Page Created But Empty
- Check the `children` array is being populated
- Verify the full_report object has data

### Slow Performance
- Notion API can take 1-3 seconds per request
- This is normal - local files save immediately

## 📞 Support

- **Test Connection**: `npm run test-notion`
- **Check Logs**: Look for Notion-related console messages
- **Verify Database**: Check database ID is correct
- **API Status**: Check [Notion Status Page](https://status.notion.so/)

---

## ✅ Summary

✅ **Automatic Notion saving** after every agent run  
✅ **Full property mapping** for all agent data  
✅ **Beautiful page formatting** with blocks and structure  
✅ **Retry logic** for reliability  
✅ **Error handling** that never blocks the user  
✅ **Telegram integration** sends Notion URLs  
✅ **CLI support** for manual runs  
✅ **Test script** to verify connection  

**Your agent is now fully integrated with Notion! 🎉**

Every voice message or text input will automatically create a searchable, organized Notion page. Check your database to see the magic! ✨
